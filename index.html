 <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RÃ©servation â€“ Salon Mireille BeautÃ©</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ğŸ’‡â€â™€ï¸ RÃ©servez votre moment beautÃ©</h1>

  <label for="date">ğŸ“… Choisissez une date :</label>
  <input type="date" id="date" onchange="loadSlots()" min="">

  <div id="slots"></div>

  <form id="clientForm" onsubmit="submitForm(event)">
    <label for="clientName">ğŸ‘¤ Votre nom :</label>
    <input type="text" id="clientName" required oninput="updateRecap()" />

    <label for="clientPhone">ğŸ“ TÃ©lÃ©phone (+1...):</label>
    <div class="phone-group">
      <input type="text" value="+1" disabled class="prefix" />
      <input type="tel" id="clientPhone" placeholder="1234567890" required class="number" oninput="updateRecap()" />
    </div>

    <label for="coiffureType">ğŸ’‡â€â™€ï¸ Type de coiffure :</label>
    <select id="coiffureType" required onchange="updateRecap()">
      <option value="">-- SÃ©lectionnez --</option>
      <option value="Brushing">Brushing</option>
      <option value="Coloration">Coloration</option>
      <option value="Tresses">Tresses</option>
      <option value="Extensions">Extensions</option>
      <option value="Soins capillaires">Soins capillaires</option>
      <option value="Coiffure Ã©vÃ©nementielle">Coiffure Ã©vÃ©nementielle</option>
      <option value="Perruques">Perruques</option>
    </select>

    <div id="recapitulatif">
      <strong>ğŸ“‹ RÃ©capitulatif :</strong>
      <p id="recapText"></p>
    </div>

    <button type="submit">âœ… Confirmer le rendez-vous</button>
  </form>

  <script>
    let allSlots = [];
    let selectedDate = "";
    let selectedTime = "";

    async function loadSlots() {
      selectedDate = document.getElementById("date").value;
      selectedTime = "";
      document.getElementById("clientForm").style.display = "none";
      document.getElementById("recapitulatif").style.display = "none";
      const container = document.getElementById("slots");
      container.innerHTML = "";

      if (!selectedDate) return;

      try {
        const resSlots = await fetch("https://mira-55g4.onrender.com /creneaux");
        allSlots = await resSlots.json();

        const res = await fetch(`https://mira-55g4.onrender.com/disponibilites?date=${selectedDate}`);
        const heuresPrises = await res.json();

        const horairesDisponibles = allSlots.filter(h => !heuresPrises.includes(h));

        if (horairesDisponibles.length === 0) {
          container.innerHTML = "<p>â›” Aucun crÃ©neau disponible pour cette date.</p>";
          return;
        }

        horairesDisponibles.forEach((time) => {
          const btn = document.createElement("button");
          btn.textContent = time;
          btn.className = "slot available";
          btn.onclick = () => {
            selectedTime = time;
            document.querySelectorAll(".slot").forEach((b) => b.classList.remove("selected"));
            btn.classList.add("selected");
            document.getElementById("clientForm").style.display = "block";
            document.getElementById("recapitulatif").style.display = "block";
            updateRecap();
          };
          container.appendChild(btn);
        });
      } catch (err) {
        console.error("âŒ Erreur chargement des crÃ©neaux :", err);
        container.innerHTML = "<p>â›” Impossible de charger les crÃ©neaux disponibles.</p>";
      }
    }

    function updateRecap() {
      const name = document.getElementById("clientName").value.trim();
      const phone = document.getElementById("clientPhone").value.trim();
      const coiffure = document.getElementById("coiffureType").value;

      document.getElementById("recapText").innerHTML = `
        ğŸ“… <strong>Date :</strong> ${selectedDate || "(Ã  choisir)"}<br>
        ğŸ•’ <strong>Heure :</strong> ${selectedTime || "(Ã  choisir)"}<br>
        ğŸ‘¤ <strong>Nom :</strong> ${name || "(Ã  remplir)"}<br>
        ğŸ“ <strong>TÃ©lÃ©phone :</strong> ${phone ? "+1" + phone : "(Ã  remplir)"}<br>
        ğŸ’‡â€â™€ï¸ <strong>Coiffure :</strong> ${coiffure || "(Ã  choisir)"}
      `;
    }

    function submitForm(event) {
      event.preventDefault();

      const name = document.getElementById("clientName").value.trim();
      const phone = "+1" + document.getElementById("clientPhone").value.trim();
      const coiffure = document.getElementById("coiffureType").value;
      const phoneRegex = /^\+1[0-9]{10}$/;

      if (!selectedDate || !selectedTime) {
        alert("â›” Veuillez sÃ©lectionner une date et une heure.");
        return;
      }

      if (!name || !phone || !coiffure) {
        alert("â›” Tous les champs doivent Ãªtre remplis.");
        return;
      }

      if (!phoneRegex.test(phone)) {
        alert("â›” NumÃ©ro de tÃ©lÃ©phone invalide. Format attendu : +1XXXXXXXXXX");
        return;
      }

      const reservationData = {
        nom: name,
        date: selectedDate,
        heure: selectedTime,
        telephone: phone,
        coiffure,
      };

      fetch("https://mira-55g4.onrender.com/notifier-mireille", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reservationData),
      })
        .then((res) => {
          if (res.ok) {
            localStorage.setItem("heureReservation", selectedTime);
            window.location.href = "confirmation.html";
          } else {
            alert("â›” Erreur lors de l'enregistrement. Veuillez rÃ©essayer.");
          }
        })
        .catch((err) => {
          console.error("âŒ Erreur rÃ©seau :", err);
          alert("â›” Impossible de contacter le serveur.");
        });
    }

    window.onload = () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("date").setAttribute("min", today);
    };
  </script>
</body>
</html>